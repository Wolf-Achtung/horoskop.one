<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>horoskop.one â€“ Mystischer Kompass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta name="description" content="Dein achtsames, erklÃ¤rbares Horoskop: individuell, mystisch, seriÃ¶s.">
  <meta property="og:title" content="horoskop.one â€“ Mystischer Kompass">
  <meta property="og:description" content="Dein achtsames, erklÃ¤rbares Horoskop: individuell, mystisch, seriÃ¶s.">
  <meta property="og:image" content="/og.png">
  <meta property="og:type" content="website">
  <style>
    :root{
      --bg:#0b1020; --bg2:#0f1630; --ink:#e7ecff; --muted:#9fb2d9;
      --chip:#0d203f; --chip-bd:#203a6b; --focus:#8cc8ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, #1a2451 0%, transparent 60%),
                            radial-gradient(900px 600px at 90% 10%, #10204a 0%, transparent 60%),
                            linear-gradient(180deg, var(--bg), var(--bg2));
         color:var(--ink); font-family:system-ui,Arial,sans-serif; line-height:1.45}
    .panel{background:linear-gradient(180deg, #0e1730, #0c1428);border:1px solid #1a2c5a;border-radius:16px;box-shadow:0 12px 36px #0008}
    .section{padding:14px}
    input,select,button{font-size:16px}
    input[type="text"],input[type="date"],input[type="time"],select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #24417b;background:#0b1530;color:#e7ecff}
    input:focus,select:focus,button:focus{outline:2px solid var(--focus);outline-offset:2px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:12px 14px;border-radius:12px;border:1px solid #2d4b8d;background:#103061;color:#fff;cursor:pointer}
    .btn.brand{background:linear-gradient(180deg,#1653a8,#0f3c7b);border-color:#2f63b3}
    .btn.ghost{background:#0c1c3e}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--chip-bd);background:var(--chip);padding:6px 10px;border-radius:999px;color:#bdd0ff;font-size:12px}
    .top-actions{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .reading{margin-top:12px}
    .card{background:linear-gradient(180deg,#0f1933,#0b1328);border:1px solid #1a2c5a;border-radius:14px;padding:16px}
    details{border:1px solid #1a2c5a;border-radius:14px;margin:10px 0;background:#0b142b}
    summary{cursor:pointer;padding:12px 14px;font-weight:700}
    .why{margin:6px 14px 12px}
    .small{font-size:12px;color:#9fb2d9}
    .disclaimer{font-size:12px;color:#7e96c9;margin-top:16px;text-align:center}
  </style>
</head>
<body>
  <main style="max-width:980px;margin:18px auto 40px;padding:0 14px">
    <section class="panel section">
      <div class="top-actions">
        <div class="right">
          <span class="chip"><span>â™Ÿ</span><span id="chip-mode">Mystic Coach</span></span>
          <span class="chip"><span>ðŸ•°</span><span id="chip-timeframe">Woche</span></span>
        </div>
        <div class="row">
          <button id="btn-heute" class="btn ghost" title="Zeitraum auf Heute stellen und starten">ðŸ”® Heute</button>
          <button class="btn ghost" id="btn-offline">Sofort-Analyse (offline)</button>
          <button class="btn brand" id="btn-gold">Gold-Reading (AI)</button>
        </div>
      </div>

      <div class="row">
        <div style="flex:1 1 220px">
          <label for="birthDate">Geburtsdatum</label>
          <input type="date" id="birthDate" />
        </div>
        <div style="flex:1 1 220px">
          <label for="birthPlace">Geburtsort</label>
          <input type="text" id="birthPlace" placeholder="z. B. Berlin" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1 1 220px">
          <label for="birthTime">Geburtszeit (optional)</label>
          <input type="time" id="birthTime" placeholder="--:--" />
        </div>
        <div style="flex:1 1 220px">
          <label for="timeApprox">â€¦oder ungefÃ¤hr</label>
          <select id="timeApprox">
            <option value="">Unbekannt</option>
            <option value="morning">Morgens (05â€“11 Uhr)</option>
            <option value="noon">Mittags (11â€“15 Uhr)</option>
            <option value="evening">Abends (15â€“22 Uhr)</option>
            <option value="night">Nachts (22â€“05 Uhr)</option>
          </select>
        </div>
        <div style="flex:1 1 220px">
          <label for="timeFrame">Vorhersagezeitraum</label>
          <select id="timeFrame">
            <option value="day">Heute</option>
            <option selected value="week">Woche</option>
            <option value="month">Monat</option>
          </select>
        </div>
      </div>

      <div id="ephemeris" class="row" style="margin-top:8px"></div>
      <div id="result" class="reading"></div>
      <div class="row" id="shareRow" style="margin-top:10px;display:none">
        <button class="btn ghost" id="btn-share">Share-Card (PNG)</button>
      </div>

      <div class="disclaimer">Unterhaltung & achtsame Selbstreflexion. Keine medizinische, rechtliche oder finanzielle Beratung.
        Bei Krisen oder akuter Gefahr: 112 (EU) / lokale Beratungsstellen.</div>
    </section>

    <section class="panel section" style="margin-top:14px">
      <div id="mixer-root"></div>
    </section>
  </main>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-presets="react" src="components/horoskop.cdn.jsx"></script>

  <script>
    const RAILWAY_BASE = "https://horoskopone-production.up.railway.app"; // ggf. anpassen
    window.__mixerState = { mode:'mystic_coach', timeframe:'week', weights:{ astro:34, num:13, tarot:17, iching:14, cn:11, tree:11 } };

    // Mixer mount + inbound chip update
    const mountMixer = () => {
      const rootEl = document.getElementById('mixer-root');
      const node = ReactDOM.createRoot(rootEl);
      node.render(React.createElement(window.KosmischerMixer));
      window.addEventListener('horoskop:mixer', (e)=>{
        window.__mixerState = e.detail;
        document.getElementById('chip-mode').textContent = e.detail.mode==='mystic_coach'?'Mystic Coach': e.detail.mode==='mystic'?'Mystisch': e.detail.mode==='skeptic'?'Skeptisch':'Coach';
        document.getElementById('chip-timeframe').textContent = e.detail.timeframe==='day'?'Heute':(e.detail.timeframe==='week'?'Woche':'Monat');
        document.getElementById('timeFrame').value = e.detail.timeframe;
      });
    };
    mountMixer();

    // Heute Shortcut
    document.getElementById('btn-heute').onclick = () => {
      window.__mixerState.timeframe = 'day';
      document.getElementById('chip-timeframe').textContent = 'Heute';
      document.getElementById('timeFrame').value = 'day';
      window.dispatchEvent(new CustomEvent('horoskop:set', { detail: { timeframe:'day' } }));
      document.getElementById('btn-gold').click();
    };

    // Offline
    document.getElementById('btn-offline').onclick = () => {
      const d=document.getElementById('birthDate').value;
      const p=document.getElementById('birthPlace').value.trim();
      const t=document.getElementById('birthTime').value;
      const a=document.getElementById('timeApprox').value||'unbekannt';
      if(!d||!p){ document.getElementById('result').textContent='Bitte Datum und Ort angeben.'; return; }
      document.getElementById('result').innerHTML = '<div class="card"><b>Kurzkompass (offline)</b><br>Datum: '+d+' Â· Ort: '+p+' Â· '+(t?('Uhrzeit '+t):('Zeit ungefÃ¤hr: '+a))+'.<br><span class="small">FÃ¼r die volle Analyse bitte â€žGold-Reading (AI)â€œ nutzen.</span></div>';
    };

    function chipTip(text){
      const LEX = {
        "Sternzeichen": "Westlicher Tierkreis aus Geburtsdatum â€“ liefert Grundstimmung.",
        "Lebenszahl": "Numerologie (Quersumme). Lernfelder & Ressourcen.",
        "Zeitfenster": "Uhrzeit oder Zeit-Bucket â€“ prÃ¤gt Tagesenergie.",
        "Ort": "Geburtsort â†’ Zeitzone, HemisphÃ¤re, Tageslicht.",
        "Tag/Nacht": "Ermittelt aus lokalen Sunrise/Sunset.",
        "Saison": "Meteorologische Jahreszeit der HemisphÃ¤re.",
        "Mondphase": "Mondzyklus am Datum (z. B. Vollmond).",
        "Sunrise/Sunset": "Auf-/Untergangszeiten vor Ort am Datum.",
        "Astrologie": "Transite und symbolische Deutung (Light).",
        "Numerologie": "Ziffernlogik als Metapher â€“ kein Determinismus.",
        "Tarot": "Archetypen als Spiegel, keine Wahrsagerei.",
        "I-Ging": "Muster/Weisheitstexte als Reflexionshilfe.",
        "Chinesisch": "12-Tierkreis (Jahr), zyklische Zuschreibungen.",
        "Baumkreis": "Keltische Symbolik, poetische Metaphern."
      };
      for(const k in LEX){ if(text.includes(k)) return LEX[k]; }
      return "Faktische oder symbolische BegrÃ¼ndung";
    }

    function fmtTime(s){
      if(!s) return '';
      try{
        const t = s.includes('T') ? s.split('T')[1] : s;
        const [hh,mm] = t.split(':');
        return `${hh}:${mm}`;
      }catch(e){ return ''; }
    }

    function setEphemeris(meta){
      const bar = document.getElementById('ephemeris'); bar.innerHTML='';
      const p = meta?.profile || {}; const e = meta?.ephemeris || {};
      const chips = [];
      if(p.place) chips.push(['ðŸ“', p.place, 'Ort']);
      if(p.timezone) chips.push(['ðŸ•’', p.timezone, 'Zeitzone']);
      if(typeof e.birth_is_day === 'boolean') chips.push(['â˜€ï¸', e.birth_is_day?'Taggeburt':'Nachtgeburt', 'Tag/Nacht']);
      if(e.season) chips.push(['ðŸœ„', e.season==='summer'?'Sommer': e.season==='spring'?'FrÃ¼hling': e.season==='autumn'?'Herbst':'Winter', 'Saison']);
      if(e.moon_phase_name) chips.push(['â˜¾', e.moon_phase_name, 'Mondphase']);
      if(e.sunrise || e.sunset) chips.push(['âŸ²', `SR ${fmtTime(e.sunrise)} Â· SS ${fmtTime(e.sunset)}`, 'Sunrise/Sunset']);
      chips.forEach(([i,t,label])=>{
        const el=document.createElement('span'); el.className='chip'; el.title=chipTip(label);
        el.innerHTML=`<span>${i}</span><span>${t}</span>`; bar.appendChild(el);
      });
    }

    let __lastData = null;

    function renderReadingUI(data){
      __lastData = data;
      const box=document.getElementById('result'); box.innerHTML="";
      setEphemeris(data.meta);

      const head=document.createElement('div'); head.className='card';
      head.innerHTML=`<div class="small">Modus: <b>${data?.meta?.mode||'-'}</b> Â· Zeitraum: <b>${data?.meta?.timeframe||'-'}</b> Â· Seed: <code>${data?.meta?.seed||'-'}</code></div>`;
      box.appendChild(head);

      if(Array.isArray(data.highlights) && data.highlights.length){
        const wrap=document.createElement('div'); wrap.className='card';
        wrap.innerHTML=`<h3 style="margin:0 0 8px 0">Deine 3 Highlights</h3>`;
        data.highlights.slice(0,3).forEach(h=>{
          const row=document.createElement('div'); row.className='row'; row.style.margin='8px 0';
          row.innerHTML=`<div style="flex:1"><b>${h.title||'Highlight'}</b><div class="small">${h.action||''}</div></div>`;
          const why=document.createElement('div'); why.className='row';
          (h.why||[]).forEach(w=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=w; chip.title=chipTip(w); why.appendChild(chip) });
          wrap.appendChild(row); wrap.appendChild(why);
        });
        box.appendChild(wrap);
      }

      (data.sections||[]).forEach((s,i)=>{
        const area = s.area && s.area!=='undefined' ? s.area : (["Fokus","Beruf","Liebe","Energie","Soziales"][i%5]);
        const det=document.createElement('details'); det.open=true;
        const summary=document.createElement('summary'); summary.textContent=area; det.appendChild(summary);
        const inner=document.createElement('div'); inner.style.padding='0 14px 12px 14px';
        inner.innerHTML = `<div style="margin-bottom:6px">${s.text||''}</div>${s.action?`<div class='small'>Aktion: ${s.action}</div>`:''}`;
        const sc=document.createElement('div'); sc.className='small'; sc.style.marginTop='6px'; sc.textContent='Selbstcheck: ' + (area==='Beruf'?'Welchen 5-Minuten-Schritt setzt du jetzt?': area==='Liebe'?'Welche kleine Geste fÃ¶rdert heute NÃ¤he?': area==='Energie'?'Was gibt dir in 5 Minuten spÃ¼rbar Kraft?': area==='Soziales'?'Wem kÃ¶nntest du kurz Danke sagen?':'Was ist heute die eine hilfreiche Sache?');
        inner.appendChild(sc);
        det.appendChild(inner);
        const why=document.createElement('div'); why.className='why';
        (s.why||[]).forEach(w=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=w; chip.title=chipTip(w); why.appendChild(chip) });
        det.appendChild(why);
        box.appendChild(det);
      });

      document.getElementById('shareRow').style.display='flex';
    }

    async function callReading(){
      const d=document.getElementById('birthDate').value;
      const p=document.getElementById('birthPlace').value.trim();
      const t=document.getElementById('birthTime').value; const a=document.getElementById('timeApprox').value || null;
      const tf=document.getElementById('timeFrame').value;
      if(!d||!p){ document.getElementById('result').textContent='Bitte Datum und Ort angeben.'; return; }
      const m=window.__mixerState || { mode:'mystic_coach', timeframe:tf, weights:{ astro:34, num:13, tarot:17, iching:14, cn:11, tree:11 } };
      m.timeframe=tf;
      const payload={ mode:m.mode, timeframe:m.timeframe, weights:m.weights,
        inputs:{ date:d, time:t||null, timeApprox:a, place:p, goals:[], mood:'neutral', style:'mystic-coach' } };
      const res=await fetch(RAILWAY_BASE.replace(/\/$/,'')+'/reading',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); if(data.error) throw new Error(data.error);
      renderReadingUI(data);
    }

    document.getElementById('btn-gold').onclick = async ()=>{
      document.getElementById('result').innerHTML='Berechne â€¦';
      try{ await callReading(); }catch(e){ document.getElementById('result').textContent='Fehler: '+(e?.message||e); }
    };

    // Share-Card (OG 1200x630)
    function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight, maxLines){
      const words = text.split(' '); let line=''; let lines=[];
      for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; const w=ctx.measureText(test).width;
        if(w>maxWidth && n>0){ lines.push(line.trim()); line=words[n]+' '; if(lines.length>=maxLines) break; } else { line=test; } }
      if(lines.length<maxLines) lines.push(line.trim());
      lines.forEach((ln,i)=> ctx.fillText(ln, x, y + i*lineHeight));
    }

    async function makeShareCard(data){
      const c=document.createElement('canvas'); c.width=1200; c.height=630;
      const ctx=c.getContext('2d');

      // Background
      const g=ctx.createLinearGradient(0,0,1200,630); g.addColorStop(0,'#0b1020'); g.addColorStop(1,'#0f1630'); ctx.fillStyle=g; ctx.fillRect(0,0,1200,630);
      // subtle stars
      ctx.fillStyle='rgba(255,255,255,.25)';
      for(let i=0;i<180;i++){ const x=Math.random()*1200, y=Math.random()*630; ctx.fillRect(x,y,1,1); }

      // Title
      ctx.fillStyle='#e7ecff'; ctx.font='700 44px system-ui, Arial'; ctx.fillText('horoskop.one', 56, 86);
      ctx.font='16px system-ui, Arial'; ctx.fillStyle='#9fb2d9'; ctx.fillText('Mystischer Kompass â€“ achtsam, erklÃ¤rbar', 56, 110);

      // Ephemeris chips
      const p=data?.meta?.profile||{}; const e=data?.meta?.ephemeris||{};
      ctx.font='18px system-ui, Arial'; ctx.fillStyle='#a9c4ff';
      const chip = (txt, ix)=>{ const x = 56 + ix*300; const y=140; ctx.fillText(txt, x, y); };
      let ix=0;
      if(p.place) chip('ðŸ“ '+p.place, ix++);
      if(p.timezone) chip('ðŸ•’ '+p.timezone, ix++);
      if(e.moon_phase_name) chip('â˜¾ '+e.moon_phase_name, ix++);

      // Highlights
      const hl = (data.highlights||[]).slice(0,3);
      ctx.fillStyle='#e7ecff'; ctx.font='600 26px system-ui, Arial'; ctx.fillText('Deine 3 Highlights', 56, 190);
      ctx.font='20px system-ui, Arial';
      let y=220;
      hl.forEach((h,i)=>{
        ctx.fillStyle='#a6b9e6'; ctx.fillText(String(i+1)+'.', 56, y);
        ctx.fillStyle='#e7ecff'; drawWrappedText(ctx, (h.title||'').toString(), 90, y, 1000, 26, 2); y+=56;
        ctx.fillStyle='#9fb2d9'; drawWrappedText(ctx, (h.action||'').toString(), 90, y-6, 1000, 24, 1); y+=34;
      });

      // Footer
      ctx.fillStyle='#7e96c9'; ctx.font='14px system-ui, Arial';
      ctx.fillText('Zeitraum: '+(data?.meta?.timeframe||'-')+'  Â·  Modus: '+(data?.meta?.mode||'-'), 56, 600);

      return c;
    }

    document.getElementById('btn-share').onclick = async ()=>{
      if(!__lastData){ alert('Bitte zuerst ein Gold-Reading erzeugen.'); return; }
      const canvas = await makeShareCard(__lastData);
      canvas.toBlob((blob)=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='horoskop-one-card.png'; a.click();
        URL.revokeObjectURL(url);
      });
    };
  </script>
</body>
</html>
